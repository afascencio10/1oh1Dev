function countdown_timer(e){countDownDate=new Date(e).getTime();var o=setInterval(function(){var e=(new Date).getTime(),t=countDownDate-e,n=Math.floor(t/864e5),a=Math.floor(t%864e5/36e5),r=Math.floor(t%36e5/6e4),i=Math.floor(t%6e4/1e3);n=n?n+"d ":"",a=a?a+"h ":"",r=r?r+"m ":"",i=i?i+"s ":"",document.getElementById("demo").innerHTML=n+a+r+i,t<0&&(clearInterval(o),document.getElementById("demo").innerHTML="EXPIRED",$("#timesUp").modal("show"))},1e3)}function replaceTracks(e){function o(o){o.getSenders().map(function(o){o.replaceTrack(e.getTracks().find(function(e){return e.kind===o.track.kind}))})}e.getTracks().forEach(function(e){localStream.addTrack(e)}),o(pcPeers[Object.keys(pcPeers)[0]])}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;const JOIN_ROOM="JOIN_ROOM",EXCHANGE="EXCHANGE",REMOVE_USER="REMOVE_USER";let currentUser,localVideo,remoteVideoContainer,localStream,pcPeers={};window.onload=(()=>{currentUser=document.getElementById("current-user").innerHTML,end_time=document.getElementsByTagName("time")[0].innerHTML,countdown_timer(end_time),seesionId=document.getElementById("session_id").innerHTML,localVideo=document.getElementById("local-video"),remoteVideoContainer=document.getElementById("remote-video-container")});const ice={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};document.onreadystatechange=(()=>{"interactive"===document.readyState&&navigator.mediaDevices.getUserMedia({video:!0,audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}}).then(e=>{localStream=e,localVideo.srcObject=e,localVideo.muted=!0})["catch"](logError)});const handleJoinSession=async()=>{$(".wrapCardPre").fadeOut(),$("#local-video-up").fadeIn(),navigator.mediaDevices.getUserMedia({video:!0,audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}}).then(e=>{localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e,localVideoUp.muted=!0})["catch"](logError),App.session=await App.cable.subscriptions.create({channel:"SessionChannel",session_id:document.getElementById("session_id").innerHTML},{connected:()=>{broadcastData({type:JOIN_ROOM,from:currentUser,session_id:seesionId})},received:e=>{if(console.log("received",e),e.from!==currentUser)switch(e.type){case JOIN_ROOM:return joinRoom(e);case EXCHANGE:if(e.to!==currentUser)return;return exchange(e);case REMOVE_USER:return removeUser(e);default:return}},speak:e=>(console.log("received",e),App.session.perform("speak",{body:e}))})},handleLeaveSession=()=>{for(user in pcPeers)pcPeers[user].close();pcPeers={},App.session.unsubscribe(),remoteVideoContainer.innerHTML="",broadcastData({type:REMOVE_USER,from:currentUser,session_id:seesionId})},handleScreenShare=function(){localStream.getTracks().forEach(function(e){e.stop()});var e={video:!0,audio:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseReduction:!1}};navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(e).then(e=>{replaceTracks(e),localStream=e,localVideoUp=document.getElementById("local-video-right"),localVideoUp.srcObject=e,localVideoUp.muted=!0})["catch"](logError):navigator.getDisplayMedia(e).then(success)["catch"](error)},handleToggleAudio=function(){document.getElementById("toggle-audio-btn").classList.toggle("active");var e=localStream.getAudioTracks();if(0!==e.length)for(var o=0;o<e.length;++o)e[o].enabled=!e[o].enabled},handleToggleVideo=function(){document.getElementById("toggle-video-btn").classList.toggle("active");var e=localStream.getVideoTracks();if(0!==e.length)for(var o=0;o<e.length;++o)e[o].enabled=!e[o].enabled},joinRoom=e=>{createPC(e.from,!0)},removeUser=e=>{console.log("removing user",e.from);let o=document.getElementById(`remoteVideoContainer+${e.from}`);o&&o.remove(),delete pcPeers[e.from],$("div#show").hide()},createPC=(e,o)=>{let t=new RTCPeerConnection(ice);return pcPeers[e]=t,t.addStream(localStream),o&&t.createOffer().then(e=>t.setLocalDescription(e)).then(()=>{broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e,sdp:JSON.stringify(t.localDescription)})})["catch"](logError),t.onicecandidate=(o=>{o.candidate&&broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e,candidate:JSON.stringify(o.candidate)})}),t.onaddstream=(o=>{const t=document.createElement("video");t.id=`remoteVideoContainer+${e}`,t.autoplay="autoplay",t.srcObject=o.stream,remoteVideoContainer.appendChild(t),$("div#show").toggle()}),t.oniceconnectionstatechange=(()=>{"disconnected"==t.iceConnectionState&&(console.log("Disconnected:",e),broadcastData({type:REMOVE_USER,from:e,session_id:seesionId}))}),t},exchange=e=>{let o;o=pcPeers[e.from]?pcPeers[e.from]:createPC(e.from,!1),e.candidate&&o.addIceCandidate(new RTCIceCandidate(JSON.parse(e.candidate))).then(()=>console.log("Ice candidate added"))["catch"](logError),e.sdp&&(sdp=JSON.parse(e.sdp),o.setRemoteDescription(new RTCSessionDescription(sdp)).then(()=>{"offer"===sdp.type&&o.createAnswer().then(e=>o.setLocalDescription(e)).then(()=>{broadcastData({type:EXCHANGE,from:currentUser,session_id:seesionId,to:e.from,sdp:JSON.stringify(o.localDescription)})})})["catch"](logError))},broadcastData=e=>{fetch("/sessions",{method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"}})},logError=e=>console.warn("Whoops! Error:",e);